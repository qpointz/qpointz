image: docker-ci.qpointz.io/ci-sbt:$CI_PROJECT_PATH_SLUG-$CI_COMMIT_REF_SLUG
stages:
  - init
  - test
  - integration
  - report
  - publish

cache:
  key: "$CI_COMMIT_SHA"
  paths:
    - project/
    - ./**/target/
    - target/
    - project/project

.job_template : &test_job
  artifacts:
    untracked: true
    paths:
      - ./**/target/test-reports/**/*
      - target/scala-*/scoverage-report/**/*
    expire_in: 10 days

buildImages:
  stage: init
  image: docker:latest
  script:
    - docker login -u $DOCKER_REPO_CI_USER -p $DOCKER_REPO_CI_PASSWORD $DOCKER_REPO_CI
    - docker build etc/docker/ci-sbt -t docker-ci.qpointz.io/ci-sbt:$CI_PROJECT_PATH_SLUG-$CI_COMMIT_REF_SLUG
    - docker push docker-ci.qpointz.io/ci-sbt:$CI_PROJECT_PATH_SLUG-$CI_COMMIT_REF_SLUG
    - docker build etc/docker/ci-npm -t docker-ci.qpointz.io/ci-npm:$CI_PROJECT_PATH_SLUG-$CI_COMMIT_REF_SLUG
    - docker push docker-ci.qpointz.io/ci-npm:$CI_PROJECT_PATH_SLUG-$CI_COMMIT_REF_SLUG

flow:test:
  <<: *test_job
  stage: test
  script:
    - sbt "project flow" clean coverage test coverageReport
  artifacts:
    reports:
      junit: ./**/*/target/test-reports/*.xml

flow:it:
  <<: *test_job
  stage: test
  script:
    - sbt "project flow" clean coverage it:test coverageReport
  artifacts:
    reports:
      junit: ./**/*/target/test-reports/*.xml

surface:test:
  <<: *test_job
  stage: test
  script:
    - sbt "project surface" clean coverage test coverageReport
  artifacts:
    reports:
      junit: ./**/*/target/test-reports/*.xml

coverage:aggregate:
  <<: *test_job
  stage: report
  script:
    - sbt coverageAggregate

scalastyle:
  stage: report
  script:
    - sbt scalastyle
    - etc/misc/checkstyle.sh
  artifacts:
    untracked: true
    paths:
      - target/scalastyle/*.*


devStack:buildImages:
  image: docker:latest
  only:
    - dev
    - master
  stage: publish
  script:
    - docker login -u $DOCKER_REPO_USER -p $DOCKER_REPO_PASSWORD $DOCKER_REPO
    - docker build etc/docker/theia-scala -t docker.qpointz.io/theia-scala
    - docker push docker.qpointz.io/theia-scala

devStack:up:
  image: docker/compose:latest
  only:
    - dev
    - master
  stage: publish
  script:
    - docker login -u $DOCKER_REPO_USER -p $DOCKER_REPO_PASSWORD $DOCKER_REPO
    - cd etc/compose/dev && docker-compose pull && docker-compose up -d