image: docker.qpointz.io/ci-sbt
stages:
 - init
 - test
 - coverage
 - publish

cache:
  key: "$CI_COMMIT_SHA"
  paths:
    - project/
    - ./**/target/
    - target/
    - project/project

.job_template : &test_job
  artifacts:
    untracked: true
    paths:
      - ./**/target/test-reports/**/*
      - target/scala-*/scoverage-report/**/*
    expire_in: 10 days

buildImages:
  stage: init
  script:
    - docker login -u $DOCKER_REPO_USER -p $DOCKER_REPO_PASSWORD $DOCKER_REPO
    - docker build etc/docker/ci-sbt/Dockerfile -t docker.qpointz.io/ci-sbt && docker push docker.qpointz.io/ci-sbt
    - docker build etc/docker/ci-npm/Dockerfile -t docker.qpointz.io/ci-npm && docker push docker.qpointz.io/ci-npm

testFlow:
  <<: *test_job
  stage: test
  script:
    - sbt "project flow" clean coverage test coverageReport
    
testSurface:
  <<: *test_job
  stage: test
  script:
    - sbt "project surface" clean coverage test coverageReport


coverageAggregate:
  <<: *test_job
  stage: coverage
  script:
    - sbt coverageAggregate

testWScalastyle:
    stage: test
    only:
      - dev
      - master
    script:
      - sbt scalastyle
      - etc/misc/checkstyle.sh
    artifacts:
         untracked: true
         paths:
           - target/scalastyle/*.*

publishDevStack:
  stage: publish
  script:
    - docker login -u $DOCKER_REPO_USER -p $DOCKER_REPO_PASSWORD $DOCKER_REPO
    - docker build etc/docker/theia-scala/Dockerfile -t docker.qpointz.io/theia-scala && docker push docker.qpointz.io/theia-scala
    - cd etc/compose/dev && docker-compose pull && docker-compose up -d