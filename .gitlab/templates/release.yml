.global-vars:
    before_script:
        - |
           if [ -n "${QP_VERSION}" ]; then
              echo "${QP_VERSION}" > ${CI_PROJECT_DIR}/VERSION
           fi
        - export QP_VERSION="$(cat ${CI_PROJECT_DIR}/VERSION)"
        - export QP_UPDATE_LATEST_CONTAINER=false
        - |
           export QP_CONTAINER_TAG="${CI_COMMIT_REF_SLUG}"
           if [ "dev" = "${CI_COMMIT_REF_SLUG}" ]
           then
              export QP_CONTAINER_TAG="${QP_VERSION}-develop"
              export QP_UPDATE_LATEST_CONTAINER=false
           fi

           export QP_VERSION="$(cat ${CI_PROJECT_DIR}/VERSION)"

           if [ "main" = "${CI_COMMIT_REF_SLUG}" ]
           then
              export QP_CONTAINER_TAG="${QP_VERSION}"
              export QP_UPDATE_LATEST_CONTAINER=true
           fi
        - >
          cat <<EOF
            QP_VERSION=${QP_VERSION}
            QP_CONTAINER_TAG=${QP_CONTAINER_TAG}
          EOF


.get-build-version:
  stage: init
  image: ${IMAGE_SEM_RELEASE}
  variables:
    GIT_STRATEGY: clone
    GL_TOKEN: ${CI_PUSH_TOKEN}
    GL_URL: "https://gitlab.qpointz.io/${CI_PROJECT_PATH}.git"
    GIT_DEPTH: 0
  script:
    - |
      export BUILD_VERSION_SFX=""
      git remote set-url origin https://gitlab.qpointz.io/${CI_PROJECT_PATH}.git
      if [ "main" = "${CI_COMMIT_REF_SLUG}" ] || [ "rc" = "${CI_COMMIT_REF_SLUG}" ]
      then
        npx semantic-release --dry-run --no-ci
      else
        export BUILD_VERSION_SFX="-${CI_COMMIT_REF_SLUG}"
        export REL_BRANCHES="--branches main,rc,$CI_COMMIT_REF_NAME"
        npx semantic-release -b ${REL_BRANCHES} --dry-run --no-ci
        echo "Version suffix:${BUILD_VERSION_SFX}"
      fi
    - echo $(cat ${CI_PROJECT_DIR}/VERSION)${BUILD_VERSION_SFX} > ${CI_PROJECT_DIR}/VERSION
    - echo "BUILD VERSION:$(cat ${CI_PROJECT_DIR}/VERSION)"
    - |
      if [ -f "${CI_PROJECT_DIR}/VERSION" ]; then
        export BUILD_VERSION=$(cat ${CI_PROJECT_DIR}/VERSION)
        export BUILD_VERSION_BASE="${BUILD_VERSION%%-*}"
        export BUILD_MINUTES_SINCE_2026=$(node -e 'const start = Date.UTC(2026,0,1,0,0,0); const now = Date.now(); const minutes = Math.floor((now - start) / 60000); console.log(minutes > 0 ? minutes : 0);')

        if [ "main" = "${CI_COMMIT_REF_SLUG}" ]; then
          export BUILD_VERSION_PEP440="${BUILD_VERSION_BASE}"
        elif [ "rc" = "${CI_COMMIT_REF_SLUG}" ]; then
          # Derive rc sequence from semantic-release output (tag-driven).
          export RC_VERSION_NO_PREFIX="${BUILD_VERSION#v}"
          export RC_NUMBER=""
          export BUILD_VERSION_BASE="$(printf '%s' "${RC_VERSION_NO_PREFIX}" | sed -nE 's/^([0-9]+\.[0-9]+\.[0-9]+)-rc\.?([0-9]+)$/\1/p')"
          export RC_NUMBER="$(printf '%s' "${RC_VERSION_NO_PREFIX}" | sed -nE 's/^([0-9]+\.[0-9]+\.[0-9]+)-rc\.?([0-9]+)$/\2/p')"
          if [ -z "${RC_NUMBER}" ]; then
            export BUILD_VERSION_BASE="$(printf '%s' "${RC_VERSION_NO_PREFIX}" | sed -nE 's/^([0-9]+\.[0-9]+\.[0-9]+)rc([0-9]+)$/\1/p')"
            export RC_NUMBER="$(printf '%s' "${RC_VERSION_NO_PREFIX}" | sed -nE 's/^([0-9]+\.[0-9]+\.[0-9]+)rc([0-9]+)$/\2/p')"
          fi
          if [ -z "${RC_NUMBER}" ] || [ -z "${BUILD_VERSION_BASE}" ]; then
            echo "ERROR: Cannot parse rc counter from BUILD_VERSION=${BUILD_VERSION}"
            echo "Expected semantic-release prerelease form like 1.2.1-rc.3"
            exit 1
          fi
          export BUILD_VERSION_PEP440="${BUILD_VERSION_BASE}rc${RC_NUMBER}"
        elif [ "dev" = "${CI_COMMIT_REF_SLUG}" ]; then
          export BUILD_VERSION_PEP440="${BUILD_VERSION_BASE}.dev${BUILD_MINUTES_SINCE_2026}"
        else
          export BUILD_VERSION_PEP440="${BUILD_VERSION_BASE}a${BUILD_MINUTES_SINCE_2026}"
        fi

        echo "BUILD_VERSION=${BUILD_VERSION}" >> version.env
        echo "BUILD_VERSION_PEP440=${BUILD_VERSION_PEP440}" >> version.env
        echo "Exported BUILD_VERSION=${BUILD_VERSION} to dotenv"
        echo "Exported BUILD_VERSION_PEP440=${BUILD_VERSION_PEP440} to dotenv"
      else
        echo "ERROR: VERSION file not found"
        exit 1
      fi
  artifacts:
    expire_in: "2 days"
    paths:
      - ${CI_PROJECT_DIR}/VERSION
    reports:
      dotenv: version.env

.semantic-release-job:
  image: ${IMAGE_SEM_RELEASE}
  variables:
    GIT_STRATEGY: clone
    GL_TOKEN: ${CI_PUSH_TOKEN}
    GL_URL: "https://gitlab.qpointz.io"
    GIT_DEPTH: 0
