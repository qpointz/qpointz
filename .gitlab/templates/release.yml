.global-vars:
    before_script:
        - |
           if [ -n "${QP_VERSION}" ]; then
              echo "${QP_VERSION}" > ${CI_PROJECT_DIR}/VERSION
           fi
        - export QP_VERSION="$(cat ${CI_PROJECT_DIR}/VERSION)"
        - export QP_UPDATE_LATEST_CONTAINER=false
        - |
           export QP_CONTAINER_TAG="${CI_COMMIT_REF_SLUG}"
           if [[ "dev" == "${CI_COMMIT_REF_SLUG}" ]]
           then
              export QP_CONTAINER_TAG="${QP_VERSION}-develop"
              export QP_UPDATE_LATEST_CONTAINER=false
           fi

           export QP_VERSION="$(cat ${CI_PROJECT_DIR}/VERSION)"

           if [[ "main" == "${CI_COMMIT_REF_SLUG}" ]]
           then
              export QP_CONTAINER_TAG="${QP_VERSION}"
              export QP_UPDATE_LATEST_CONTAINER=true
           fi
        - >
          cat <<EOF
            QP_VERSION=${QP_VERSION}
            QP_CONTAINER_TAG=${QP_CONTAINER_TAG}
          EOF


.get-build-version:
  stage: init
  image: ${IMAGE_SEM_RELEASE}
  variables:
    GIT_STRATEGY: clone
    GL_TOKEN: ${CI_PUSH_TOKEN}
    GL_URL: "https://gitlab.qpointz.io/${CI_PROJECT_PATH}.git"
    GIT_DEPTH: 0
  script:
    - |
      export BUILD_VERSION_SFX=""
      git remote set-url origin https://gitlab.qpointz.io/${CI_PROJECT_PATH}.git
      if [[ "main" == "${CI_COMMIT_REF_SLUG}" || "rc" == "${CI_COMMIT_REF_SLUG}" ]]
      then
        npx semantic-release --dry-run --no-ci
      else
        export BUILD_VERSION_SFX="-${CI_COMMIT_REF_SLUG}"
        export REL_BRANCHES="--branches main,rc,$CI_COMMIT_REF_NAME"
        npx semantic-release -b ${REL_BRANCHES} --dry-run --no-ci
        echo "Version suffix:${BUILD_VERSION_SFX}"
      fi
    - echo $(cat ${CI_PROJECT_DIR}/VERSION)${BUILD_VERSION_SFX} > ${CI_PROJECT_DIR}/VERSION
    - echo "BUILD VERSION:$(cat ${CI_PROJECT_DIR}/VERSION)"
    - |
      if [ -f "${CI_PROJECT_DIR}/VERSION" ]; then
        export BUILD_VERSION=$(cat ${CI_PROJECT_DIR}/VERSION)
        echo "BUILD_VERSION=${BUILD_VERSION}" >> version.env
        echo "Exported BUILD_VERSION=${BUILD_VERSION} to dotenv"
      else
        echo "ERROR: VERSION file not found"
        exit 1
      fi
  artifacts:
    expire_in: "2 days"
    paths:
      - ${CI_PROJECT_DIR}/VERSION
    reports:
      dotenv: version.env

.semantic-release-job:
  image: ${IMAGE_SEM_RELEASE}
  variables:
    GIT_STRATEGY: clone
    GL_TOKEN: ${CI_PUSH_TOKEN}
    GL_URL: "https://gitlab.qpointz.io"
    GIT_DEPTH: 0
